<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hui Shen's Travel Map</title>

    <link rel="icon" type="image/x-icon" href="../images/favicons/favicon.ico">
        
    
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../stylesheet.css">
    <link rel="stylesheet" href="../css/travel_map.css">

    <link rel="stylesheet" href="../leaflet/dist/leaflet.css" />
    <script src="../leaflet/dist/leaflet.js"></script>
</head>
<body>

    <!-- Header -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary header">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Cloud Driver é›²ç«¯å¸æ©Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="../index.html">HomeğŸ§</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../publications.html">PublicationsğŸ“•</a>
                </li>
                <li class="nav-item">
                  <a data-bs-toggle="offcanvas" href="#contact_me" role="button" class="nav-link">Contact MeğŸŒ»</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link active dropdown-toggle" aria-current="page" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    When I'm Not Doing ResearchğŸŒŠ
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="./travel_map.html">Travel Map</a></li>
                        <li><a class="dropdown-item" href="./music.html">Music</a></li>
                        <li><a class="dropdown-item" href="./transfer_guide.html">Transfer Guide</a></li>
                        <!-- <li><a class="dropdown-item" href="./game.html">Game</a></li> -->
                    </ul>
                </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Offcanvas -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="contact_me" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Contact Me</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <strong>WeChat:</strong><br>
            DiudiuandMoon
            <hr>
            <strong>RedNote/å°çº¢ä¹¦:</strong><br>
            9428710724
        </div>
    </div>

  <div class="container">
    <div class="map-header text-center">
        <h1 class="map-title">My Travel Map</h1>
        <div class="title-underline mx-auto"></div>
        <p class="map-subtitle">Visited & Lived Â· æ—…è¡Œè¶³è¿¹ä¸å±…ä½åœ°</p>
        <p class="text-center text-muted" style="margin-top:-6px;">
        Click any marker to open my travel notes and photos for that place.
        </p>
    </div>
    <div class="map-card">
        <div id="map"></div>
    </div>

    <script>
        // Create map with horizontal wrap behavior (left-right loops).
        const map = L.map('map', { worldCopyJump: true });

        // Base tiles (horizontal wrap allowed by default)
        const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

        // Fit a single world to the viewport, then lock that as the minimum zoom
        map.fitWorld({ animate: false });
        const worldZoom = map.getZoom();
        map.setMinZoom(worldZoom);

        // åˆå§‹ç•¥å¾® zoom inï¼ˆæƒ³å†è¿‘ä¸€ç‚¹ç”¨ +2ï¼‰
        map.setView([20, 0], worldZoom + 1);

        // Build legend (bottom-right)
        const Legend = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
            <div class="row"><span class="dot visited"></span>Visited</div>
            <div class="row"><span class="dot lived"></span>Lived</div>
            `;
            // Prevent map dragging when interacting with legend (good for mobile)
            L.DomEvent.disableClickPropagation(div);
            return div;
        }
        });
        map.addControl(new Legend());

        // Create a factory to build DivIcons by type
        function makeIcon(type) {
        const className = `modern-marker ${type === 'lived' ? 'lived' : 'visited'}`;
        return L.divIcon({ className, iconSize: [25, 25] });
        }

        // Tooltip timers per marker
        const hideTimers = new WeakMap();
        const markers = [];

        function openTooltipWithCancel(marker) {
        const t = hideTimers.get(marker);
        if (t) clearTimeout(t);
        marker.openTooltip();
        }
        function scheduleCloseTooltip(marker, delay = 1000) {
        const timer = setTimeout(() => marker.closeTooltip(), delay);
        hideTimers.set(marker, timer);
        }

        fetch('../travel_notes/visited.json')
        .then(res => {
            if (!res.ok) throw new Error('Failed to load visited.json');
            return res.json();
        })
        .then(places => {
        const entries = []; // ç»Ÿä¸€æ”¶æ‹¢ä»¥å¤„ç† map ç‚¹å‡»/æ‹–åŠ¨æ—¶å»¶è¿Ÿå…³é—­

        places.forEach(place => {
            const type = (place.type || 'visited').toLowerCase();
            const marker = L.marker(place.coords, { icon: makeIcon(type) }).addTo(map);

            // ç”Ÿæˆ tooltip HTMLï¼šæ ‡é¢˜ + å°æŒ‰é’®ï¼ˆå¦‚æœæä¾›äº† urlï¼‰
            const linkHTML = place.url
            ? `<a href="${place.url}" target="_blank" rel="noopener" class="tt-btn" title="Open notes & photos">View notes & photos â†’</a>`
            : '';
            const html = `<div class="tt-wrap">
                            <div class="tt-title">${place.name}</div>
                            ${linkHTML}
                        </div>`;

            // æ‰‹åŠ¨æ§åˆ¶çš„ tooltipï¼ˆæ”¯æŒäº¤äº’ï¼‰
            const tt = L.tooltip({
            direction: 'top',
            offset: [0, -12],
            opacity: 0.95,
            className: 'my-tooltip',
            interactive: true         // å…è®¸é¼ æ ‡è¿›å…¥ tooltip
            }).setContent(html);

            let hideTimer = null;

            const showTT = () => {
            if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
            tt.setLatLng(marker.getLatLng());
            if (!map.hasLayer(tt)) {
                tt.addTo(map);
                // ç¬¬ä¸€æ¬¡æ¸²æŸ“åç»™ tooltip DOM ç»‘å®šäº‹ä»¶ï¼Œé˜²æ­¢ç§»å…¥æ—¶ç«‹åˆ»æ¶ˆå¤±
                const el = tt.getElement();
                if (el && !el.dataset.wired) {
                el.dataset.wired = '1';
                el.addEventListener('mouseenter', () => {
                    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
                });
                el.addEventListener('mouseleave', () => scheduleHideTT(2000));
                // é¿å…ç‚¹å‡»æŒ‰é’®è§¦å‘ map çš„ clickï¼ˆä¼šå®‰æ’å…³é—­ï¼‰
                el.addEventListener('click', (e) => e.stopPropagation(), true);
                }
            }
            };

            const scheduleHideTT = (delay = 2000) => {
            if (hideTimer) clearTimeout(hideTimer);
            hideTimer = setTimeout(() => {
                if (map.hasLayer(tt)) map.removeLayer(tt);
                hideTimer = null;
            }, delay);
            };

            // æ¡Œé¢ï¼šæ‚¬åœæ˜¾ç¤ºï¼Œç¦»å¼€ 2s åéšè—
            marker.on('mouseover', showTT);
            marker.on('mouseout',  () => scheduleHideTT(2000));

            // æ— éšœç¢ï¼šé”®ç›˜ç„¦ç‚¹
            marker.on('focus', showTT);
            marker.on('blur',  () => scheduleHideTT(2000));

            // ç§»åŠ¨ç«¯ï¼šç‚¹ marker æ˜¾ç¤ºï¼›ç‚¹ç©ºç™½å¤„/æ‹–åŠ¨å 2s å…³é—­
            marker.on('click', (e) => { L.DomEvent.stopPropagation(e); showTT(); });

            entries.push({ scheduleHideTT, tt });
        });

        // ç‚¹å‡»ç©ºç™½æˆ–å¼€å§‹æ‹–åŠ¨ -> 2s åç»Ÿä¸€å…³é—­ï¼ˆç»™ç§»åŠ¨ç«¯è‰¯å¥½ä½“éªŒï¼‰
        map.on('click',     () => entries.forEach(e => e.scheduleHideTT(2000)));
        map.on('dragstart', () => entries.forEach(e => e.scheduleHideTT(2000)));
        })
        .catch(err => {
            console.error(err);
            // Optional: tell the user in-page (non-blocking)
            const warn = L.control({ position: 'topright' });
            warn.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `<strong>Could not load visited.json</strong><div>Please check the file path & format.</div>`;
            return div;
            };
            warn.addTo(map);
        });
    </script>

  </div>

  <script src="../js/bootstrap.bundle.min.js"></script>
  <script src="../js/d3.v7.min.js"></script>
  <script src="../js/topojson.min.js"></script>
  <script src="../js/travel_map.js"></script>
</body>
</html>
